<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WBL Pipeline Map</title>
  <style>
    :root {
      --bg: #f3f0e8;
      --ink: #182018;
      --muted: #4f5f53;
      --line: #9aa89d;
      --canon: #136f63;
      --canon-soft: #d8efe7;
      --forecast: #b45309;
      --forecast-soft: #fde9cf;
      --card: #fffdfa;
      --chip-bg: #ffffff;
      --node-bg: #fffdf8;
      --notes-bg: rgba(255, 255, 255, .6);
      --shadow: rgba(24, 32, 24, .06);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 2rem 1.25rem 3rem;
      font-family: "Space Grotesk", "Segoe UI", Tahoma, sans-serif;
      background:
        radial-gradient(circle at 8% 12%, #ffffff 0, #f3f0e8 45%),
        radial-gradient(circle at 86% 84%, #ece6d7 0, #f3f0e8 40%);
      color: var(--ink);
    }

    .wrap {
      max-width: 1180px;
      margin: 0 auto;
    }

    h1 {
      margin: 0 0 .5rem;
      font-size: clamp(1.4rem, 2.2vw, 2.2rem);
      letter-spacing: .01em;
    }

    .subtitle {
      margin: 0 0 1.25rem;
      color: var(--muted);
      font-size: .98rem;
      line-height: 1.4;
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: .5rem;
      margin: 0 0 1.3rem;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: .4rem;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: var(--chip-bg);
      font-size: .82rem;
      padding: .35rem .62rem;
    }

    .dot {
      width: .65rem;
      height: .65rem;
      border-radius: 50%;
    }

    .dot.canon { background: var(--canon); }
    .dot.forecast { background: var(--forecast); }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    .lane {
      border: 1px solid var(--line);
      border-radius: 14px;
      overflow: hidden;
      background: var(--card);
      box-shadow: 0 8px 20px var(--shadow);
    }

    .lane-h {
      padding: .7rem .9rem;
      font-weight: 700;
      letter-spacing: .01em;
      border-bottom: 1px solid var(--line);
    }

    .lane.canon .lane-h {
      background: var(--canon-soft);
      color: #0b3d35;
    }

    .lane.forecast .lane-h {
      background: var(--forecast-soft);
      color: #5f3207;
    }

    .lane-body {
      padding: .8rem;
      display: grid;
      grid-template-columns: 1.25fr .9fr .9fr;
      gap: .7rem;
      align-items: start;
    }

    .block {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: .65rem .7rem;
      background: var(--chip-bg);
    }

    .block h3 {
      margin: 0 0 .45rem;
      font-size: .88rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .05em;
    }

    .node {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: .45rem .52rem;
      margin: .38rem 0;
      background: var(--node-bg);
      font-size: .84rem;
      line-height: 1.28;
    }

    .node strong { display: block; font-size: .86rem; }

    .arrow {
      text-align: center;
      font-weight: 700;
      color: var(--muted);
      font-size: .9rem;
      margin: .25rem 0;
    }

    .notes {
      margin-top: 1rem;
      border: 1px dashed var(--line);
      border-radius: 10px;
      padding: .8rem .9rem;
      background: var(--notes-bg);
      font-size: .84rem;
      line-height: 1.35;
    }

    .notes h2 {
      margin: 0 0 .45rem;
      font-size: .95rem;
      letter-spacing: .01em;
    }

    .notes ul {
      margin: .1rem 0 0 1rem;
      padding: 0;
    }

    .notes li { margin: .22rem 0; }

    .view-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      font-size: .84rem;
    }

    .view-table th,
    .view-table td {
      text-align: left;
      padding: .45rem .6rem;
      border-bottom: 1px solid var(--line);
    }

    .view-table th {
      font-weight: 700;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .04em;
      font-size: .78rem;
    }

    .view-table .tag {
      display: inline-block;
      border-radius: 4px;
      padding: .15rem .4rem;
      font-size: .78rem;
      font-weight: 600;
    }

    .tag.canon {
      background: var(--canon-soft);
      color: #0b3d35;
    }

    .tag.forecast {
      background: var(--forecast-soft);
      color: #5f3207;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0f1412;
        --ink: #e5eee8;
        --muted: #a9bbb0;
        --line: #3a4a42;
        --canon: #37b7a6;
        --canon-soft: #133933;
        --forecast: #f3a24f;
        --forecast-soft: #4a2d10;
        --card: #18201c;
        --chip-bg: #1e2923;
        --node-bg: #202d26;
        --notes-bg: rgba(26, 36, 31, .85);
        --shadow: rgba(0, 0, 0, .35);
      }

      body {
        background:
          radial-gradient(circle at 8% 12%, #1a2320 0, #0f1412 45%),
          radial-gradient(circle at 86% 84%, #111916 0, #0f1412 40%);
      }

      .lane.canon .lane-h, .tag.canon { color: #bdf3e8; }
      .lane.forecast .lane-h, .tag.forecast { color: #ffd5a7; }
    }

    @media (max-width: 940px) {
      .lane-body { grid-template-columns: 1fr; }
      .arrow { transform: rotate(90deg); display: inline-block; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>WBL Data Pipelines</h1>
    <p class="subtitle">
      Two pipelines that answer different questions.
      <strong>Canonical Current</strong>: "What is this player worth right now?" &mdash;
      <strong>Forecasting Model</strong>: "What does the model predict for next season?"
      These are intentionally separate. Numbers may differ between them and that's correct.
    </p>

    <div class="legend">
      <span class="chip"><span class="dot canon"></span>Canonical Current &mdash; modal-equivalent truth</span>
      <span class="chip"><span class="dot forecast"></span>Forecasting Model &mdash; ensemble projections</span>
    </div>

    <div class="grid">
      <!-- ======== CANONICAL CURRENT ======== -->
      <section class="lane canon">
        <div class="lane-h">Canonical Current &mdash; "What is this player worth right now?"</div>
        <div class="lane-body">
          <div class="block">
            <h3>Data Sources</h3>
            <div class="node">
              <strong>TrueRatingsService</strong>
              getPitcherTrueRatings(year) / getHitterTrueRatings(year) &mdash;
              authoritative TR, components, blended rates. Cached per year.
            </div>
            <div class="node">
              <strong>TeamRatingsService (TFR pools)</strong>
              getUnifiedPitcherTfrData / getUnifiedHitterTfrData &mdash;
              canonical TFR, prospect context, development curves.
            </div>
            <div class="node">
              <strong>ModalDataService</strong>
              resolveCanonicalPitcherData / resolveCanonicalBatterData &mdash;
              TR/TFR override logic extracted from profile modals.<br>
              computePitcherProjection / computeBatterProjection &mdash;
              projection math extracted from modal renderProjectionContent().
            </div>
            <div class="node">
              <strong>CanonicalCurrentProjectionService</strong>
              Batches the above per-team for Trade Analyzer.
              Builds ProjectedPlayer/ProjectedBatter snapshots using modal-equivalent path.
            </div>
            <div class="node">
              <strong>ProjectionService (IP utility only)</strong>
              calculateProjectedIp &mdash; shared utility for innings-pitched estimation.
              Used by CanonicalCurrentProjectionService and PitcherProfileModal.
              <em>Not</em> used for full projections or ensemble math within this pipeline.
            </div>
          </div>

          <div class="arrow">&rarr;</div>

          <div class="block">
            <h3>Consumers</h3>
            <div class="node">
              <strong>Profile Modals</strong>
              BatterProfileModal / PitcherProfileModal &mdash;
              always re-resolve canonical data inline.
            </div>
            <div class="node">
              <strong>Trade Analyzer</strong>
              Via CanonicalCurrentProjectionService.
              Player ratings, projected WAR, trade evaluation all modal-equivalent.
            </div>
            <div class="node">
              <strong>True Ratings View</strong>
              Canonical TR/TFR maps as source of truth for rating tables.
            </div>
            <div class="node">
              <strong>Team Planning</strong>
              Canonical TR maps for MLB ratings. TFR pools for prospect ceilings.
            </div>
            <div class="node">
              <strong>Farm Rankings</strong>
              TFR pools for prospect rankings and Farm Score.
            </div>
            <div class="node">
              <strong>Team Ratings: Power Rankings</strong>
              Canonical TR for weighted-average team strength.
            </div>
            <div class="node">
              <strong>Global Search</strong>
              Canonical TR + TFR pools for player search results and modal launch.
            </div>
            <div class="node">
              <strong>Explain Tool</strong>
              Modal-equivalent path for CLI projection traces.
            </div>
          </div>
        </div>
      </section>

      <!-- ======== FORECASTING MODEL ======== -->
      <section class="lane forecast">
        <div class="lane-h">Forecasting Model &mdash; "What does the model predict?"</div>
        <div class="lane-body">
          <div class="block">
            <h3>Data Sources</h3>
            <div class="node">
              <strong>ProjectionService</strong>
              getProjections*(baseYear) &mdash;
              computes own TR from scratch, 3-model ensemble
              (40% optimistic, 30% neutral, 30% pessimistic),
              IP projection pipeline. Supports arbitrary year + preSeasonOnly flag.
            </div>
            <div class="node">
              <strong>BatterProjectionService</strong>
              getProjectionsWithContext(baseYear) &mdash;
              hitter batch projections with same ensemble approach.
            </div>
            <div class="node">
              <strong>TeamRatingsService.getProjectedTeamRatings()</strong>
              Combines pitcher + hitter projection outputs
              into team WAR, win projections, standings.
            </div>
          </div>

          <div class="arrow">&rarr;</div>

          <div class="block">
            <h3>Consumers</h3>
            <div class="node">
              <strong>Projections View</strong>
              Player projection tables with year selector and backtesting.
            </div>
            <div class="node">
              <strong>Team Ratings: Projections + Standings</strong>
              Team WAR projections, win projections, Pythagorean records.
              Pre-season / Current Year Stats toggle controls stats year.
            </div>
            <div class="node">
              <strong>Analysis Services</strong>
              ProjectionAnalysisService, BatterProjectionAnalysisService &mdash;
              internal analytical consumers.
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- ======== VIEW SUMMARY TABLE ======== -->
    <table class="view-table">
      <thead>
        <tr>
          <th>View / Mode</th>
          <th>Pipeline</th>
          <th>Question it answers</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Profile Modals</td>
          <td><span class="tag canon">Canonical</span></td>
          <td>Deep dive on a player's current true level</td>
        </tr>
        <tr>
          <td>Trade Analyzer</td>
          <td><span class="tag canon">Canonical</span></td>
          <td>Evaluate trade assets at current true value</td>
        </tr>
        <tr>
          <td>True Ratings</td>
          <td><span class="tag canon">Canonical</span></td>
          <td>League-wide current ratings dashboard</td>
        </tr>
        <tr>
          <td>Farm Rankings</td>
          <td><span class="tag canon">Canonical</span></td>
          <td>Prospect rankings by TFR</td>
        </tr>
        <tr>
          <td>Team Planning</td>
          <td><span class="tag canon">Canonical</span></td>
          <td>Roster construction with current ratings</td>
        </tr>
        <tr>
          <td>Team Ratings: Power Rankings</td>
          <td><span class="tag canon">Canonical</span></td>
          <td>Current team strength via TR</td>
        </tr>
        <tr>
          <td>Team Ratings: Projections &amp; Standings</td>
          <td><span class="tag forecast">Forecast</span></td>
          <td>Model-predicted season outcomes</td>
        </tr>
        <tr>
          <td>Projections View</td>
          <td><span class="tag forecast">Forecast</span></td>
          <td>Per-player forward projections, backtesting</td>
        </tr>
        <tr>
          <td>Global Search</td>
          <td><span class="tag canon">Canonical</span></td>
          <td>Player search results with canonical TR + TFR context</td>
        </tr>
        <tr>
          <td>Explain Tool (CLI)</td>
          <td><span class="tag canon">Canonical</span></td>
          <td>Debug modal-equivalent projection traces</td>
        </tr>
        <tr>
          <td>Data Management</td>
          <td><span class="tag canon">Canonical</span></td>
          <td>Data upload + cache priming (infrastructure, not analytical)</td>
        </tr>
        <tr>
          <td>Other views<br><small style="color:var(--muted)">DevTracker, Analytics, DraftBoard, Calculators, About, Onboarding, PotentialStats, RatingEstimator</small></td>
          <td>&mdash;</td>
          <td>No pipeline service dependency</td>
        </tr>
      </tbody>
    </table>

    <div class="notes">
      <h2>Key Design Decisions</h2>
      <ul>
        <li><strong>Two pipelines, not a mismatch.</strong> Canonical Current and Forecasting Model answer different questions. A player's projected WAR may differ between them &mdash; that's expected, not a bug.</li>
        <li><strong>Canonical TR is authoritative.</strong> TrueRatingsService is the single source of truth for current ratings. The Forecasting Model computes its own TR internally for ensemble inputs but does not expose those as player ratings.</li>
        <li><strong>Modal parity guarantee.</strong> Any view tagged Canonical should show the same ratings and projection numbers as opening that player's profile modal. CanonicalCurrentProjectionService exists to batch this for Trade Analyzer.</li>
        <li><strong>Forecasting Model is self-contained.</strong> It computes its own TR from arbitrary-year stats, uses ensemble math, supports backtesting and pre-season mode. It doesn't depend on TrueRatingsService and that's intentional &mdash; it needs to work for any historical year.</li>
        <li><strong>Team Ratings splits intentionally.</strong> Power Rankings mode uses Canonical (current team strength). Projections/Standings modes use Forecasting (model predictions). Different tabs, different questions.</li>
        <li><strong>Shared utility exception.</strong> ProjectionService.calculateProjectedIp() is used by canonical consumers (PitcherProfileModal, CanonicalCurrentProjectionService) for innings-pitched estimation only. This is a stateless utility call, not a full-projection dependency &mdash; no ensemble math, no TR computation, no forecasting output crosses the pipeline boundary.</li>
      </ul>
    </div>
  </div>
</body>
</html>
